from langchain_core.messages import HumanMessage
from config import llm
from summary_state import State
import os


def format_article_text(state: State) -> dict:
    a = state["article"]
    print(a)
    full_text = f"""
Τίτλος: {a.get("title", "")}
Υπότιτλος: {a.get("subtitle", "")}

Κείμενο:
{a.get("body", "")}


"""
    return {"article_text": full_text.strip()}

#Λέξεις-κλειδιά: {a.get("keywords", "")}



def explain_terms(state: State) -> dict:
    prompt = f"""
Εντοπίζεις και επεξηγείς δύσκολες ή τεχνικές λέξεις/όρους που συναντώνται στο παρακάτω άρθρο, ώστε να είναι πιο κατανοητό για ένα ευρύ, μη εξειδικευμένο κοινό.

Οδηγίες:
- Αναγνώρισε όρους που μπορεί να είναι δυσνόητοι (π.χ. νομικοί, οικονομικοί, θεσμικοί).
- Για κάθε όρο, γράψε μια σύντομη επεξήγηση (1–2 προτάσεις) σε απλή γλώσσα.
- Απόφυγε την επανάληψη, μην εξηγείς προφανείς λέξεις.
- Απόφυγε αυθαίρετες ερμηνείες ή επιπλέον πληροφορίες που δεν βασίζονται στο άρθρο.

Άρθρο:
{state["article_text"]}
"""
    res = llm.invoke([HumanMessage(content=prompt)])
    return {"explanations": res.content}


#-Εάν υπάρχουν φράσεις σε **έντονη γραφή**, δώσε προτεραιότητα σε αυτές. prolast

def generate_summary(state: State) -> dict:
    prompt = f"""
Ενσαρκώνεις τον ρόλο ενός έμπειρου επαγγελματία δημοσιογράφου. Σκοπός σου είναι να συντάξεις συνοπτική, πλήρη και ακριβή περίληψη του παρακάτω ελληνικού άρθρου, σε μορφή bullets.

Οδηγίες:
- Δημιούργησε έως 4 bullets, με συνολικό μήκος 50–100 λέξεις.
- Κάθε bullet πρέπει να περιγράφει ένα βασικό γεγονός, επιχείρημα ή σημείο του άρθρου.
- Απόφυγε γενικότητες και αόριστες διατυπώσεις.
- Μην ξεκινάς τα bullets με άρθρα (π.χ. «Η», «Ο», «Το»).
- Διατήρησε ουδέτερο και επίσημο ύφος, όπως αυτό του αρχικού άρθρου.
- Η περίληψη πρέπει να βασίζεται αυστηρά στο περιεχόμενο του άρθρου, χωρίς προσθήκες ή εικασίες.
-Σημείωση: Ορισμένες λέξεις ή φράσεις εμφανίζονται ανάμεσα σε διπλούς αστερίσκους (π.χ. **παράδειγμα**). Αυτό σημαίνει ότι στο αρχικό άρθρο ήταν γραμμένες με έντονη γραφή (bold) και μπορεί να είναι σημαντικές για την περιληψη.:

{state["article_text"]}
"""
    res = llm.invoke([HumanMessage(content=prompt)])
    return {"summary": res.content}


def generate_questions(state: State) -> dict:
    prompt = f"""
Ενσαρκώνεις τον ρόλο ειδικού στην κατανόηση και αξιολόγηση ελληνικών κειμένων. Ο στόχος σου είναι να δημιουργήσεις 5–7 καλοδομημένες ερωτήσεις που να ελέγχουν εις βάθος την κατανόηση του παρακάτω άρθρου.

Οδηγίες:
- Βασίσου αποκλειστικά στο περιεχόμενο του άρθρου.
- Εστίασε σε βασικές ιδέες, επιχειρήματα, αιτίες και συνέπειες.
- Χρησιμοποίησε ποικιλία ερωτηματικών τύπων (π.χ. Τι, Γιατί, Πώς, Ποιοι, Πότε).
- Φρόντισε οι ερωτήσεις να είναι σαφείς, στοχευμένες και απαλλαγμένες από πλεονασμούς ή ασαφείς διατυπώσεις.
- Ανάδειξε τα σημαντικότερα θέματα και μηνύματα του κειμένου.
- Μην περιλαμβάνεις ερωτήσεις που βασίζονται σε εξωτερικές γνώσεις ή γενικά συμπεράσματα.
-Σημείωση: Ορισμένες λέξεις ή φράσεις εμφανίζονται ανάμεσα σε διπλούς αστερίσκους (π.χ. **παράδειγμα**). Αυτό σημαίνει ότι στο αρχικό άρθρο ήταν γραμμένες με έντονη γραφή (bold) και μπορεί να είναι σημαντικές για την κατανόηση του περιεχομένου.:

{state["article_text"]}
"""
    res = llm.invoke([HumanMessage(content=prompt)])
    return {"questions": res.content}


def answer_questions(state: State) -> dict:
    prompt = f"""
Ενεργείς ως ειδικός στην κατανόηση και σύνθεση πληροφοριών από κείμενα. Ο ρόλος σου είναι να απαντήσεις με ακρίβεια στις ερωτήσεις που ακολουθούν, βασισμένος αποκλειστικά στην παρεχόμενη περίληψη του άρθρου.

Οδηγίες:
- Εστίασε στα σημαντικότερα σημεία της περίληψης, δίνοντας έμφαση σε κρίσιμες πληροφορίες.
- Οι απαντήσεις σου να είναι σύντομες, σαφείς και ακριβείς.
- Ανέδειξε αίτια, συνέπειες και λογικές σχέσεις όπου είναι εμφανείς.
- Μην προσθέτεις προσωπικές εκτιμήσεις ή πληροφορίες που δεν δηλώνονται ρητά στην περίληψη.

Περίληψη:
{state['summary']}

Ερωτήσεις:
{state['questions']}
"""
    res = llm.invoke([HumanMessage(content=prompt)])
    return {"answers": res.content}


def evaluate_answers(state: State) -> dict:
    prompt = f"""
Ενεργείς ως αξιολογητής κατανόησης και σύνοψης κειμένου. Ο ρόλος σου είναι να αξιολογήσεις τις απαντήσεις κατανόησης σε σχέση με το πλήρες άρθρο και την αρχική περίληψη (σε bullets).

Τα σχόλιά σου θα χρησιμοποιηθούν για τη βελτίωση της περίληψης σε επόμενο βήμα.

Οδηγίες:

1. Εντόπισε ελλείψεις:
   - Προσδιόρισε ποιες βασικές πληροφορίες από το άρθρο δεν καλύπτονται στην περίληψη, και εξήγησε γιατί ορισμένες απαντήσεις είναι ελλιπείς ή ασαφείς.

2. Αξιολόγησε την πληρότητα των απαντήσεων:
   - Έλεγξε αν οι απαντήσεις αντανακλούν με ακρίβεια το περιεχόμενο του άρθρου και καλύπτουν τα σημαντικότερα σημεία.

3. Δώσε σαφή και χρήσιμα σχόλια:
   - Παράθεσε συγκεκριμένες προτάσεις βελτίωσης της περίληψης ώστε να καλύπτει καλύτερα τις ερωτήσεις. Εστίασε σε γεγονότα, επιχειρήματα, αιτίες και συνέπειες.

4. Ακρίβεια και αλήθεια:
   - Μην εισάγεις πληροφορίες που δεν υπάρχουν στο αρχικό άρθρο.
   - Απόφυγε γενικολογίες και αόριστες εκφράσεις.

Σημείωση:
Οι λέξεις ή φράσεις που εμφανίζονται ανάμεσα σε διπλούς αστερίσκους (π.χ. **παράδειγμα**) προέρχονται από έντονη γραφή στο αρχικό άρθρο. Μπορεί να είναι σημαντικές και να υποδηλώνουν βασικά σημεία.

Παρακάτω τα δεδομένα:

Άρθρο:
{state["article_text"]}

Περίληψη:
{state['summary']}

Ερωτήσεις:
{state['questions']}

Απαντήσεις:
{state['answers']}
"""
    res = llm.invoke([HumanMessage(content=prompt)])
    evaluation_text = res.content
    success_phrases = ["δεν υπάρχουν προβλήματα", "όλα είναι σωστά", "η περίληψη είναι επαρκής"]
    should_continue = not any(p in evaluation_text.lower() for p in success_phrases)
    #print("evaluation_count ", state.get("iteration_count", 0))
    #print("evaluation_complete", not should_continue)
    #print(evaluation_text)
    
    return {
        "feedback": evaluation_text,
        "evaluation_complete": not should_continue,
        "iteration_count": state.get("iteration_count", 0) + 1
    }


def improve_summary(state: State) -> dict:
    prompt = f"""
Αναλαμβάνεις τον ρόλο του επιμελητή περιλήψεων. Ο στόχος σου είναι να βελτιώσεις μια αρχική περίληψη άρθρου (σε bullets), αξιοποιώντας τα σχόλια αξιολόγησης και το πλήρες κείμενο του άρθρου.

### Σκοπός:
Δημιούργησε μια τελική περίληψη που να είναι συνοπτική, ακριβής και πλήρως ευθυγραμμισμένη με το περιεχόμενο του άρθρου.

### Οδηγίες:

- Ενσωμάτωσε ή διόρθωσε bullets ώστε να καλύπτουν όλα τα ουσιώδη σημεία του άρθρου.
- Κράτησε τη διατύπωση των καλά διατυπωμένων bullets ως έχει, εφόσον είναι σαφής και κατάλληλη.
- Δημιούργησε έως 4 bullets, με συνολικό μήκος 50–100 λέξεις.
- Κάθε bullet να περιγράφει ξεκάθαρα ένα βασικό γεγονός, επιχείρημα ή στοιχείο του άρθρου.
- Απόφυγε γενικότητες και ασαφείς διατυπώσεις.
- Μην ξεκινάς bullets με άρθρα (π.χ. "Η", "Το"). Προτίμησε ενεργητική και άμεση σύνταξη.
- Διατήρησε το ύφος του άρθρου (ουδέτερο, επίσημο κ.λπ.).
- Μην εισάγεις πληροφορίες που δεν περιλαμβάνονται ρητά στο άρθρο.

### Σημείωση:
Φράσεις μέσα σε διπλούς αστερίσκους (π.χ. **παράδειγμα**) προέρχονται από έντονη γραφή στο αρχικό άρθρο. Υποδεικνύουν πιθανή σημασία και αξίζει να τις λάβεις υπόψη.:

Αρθρο:
{state['article_text']}

Περίληψη:
{state['summary']}

Σχόλια:
{state['feedback']}
"""
    res = llm.invoke([HumanMessage(content=prompt)])
    #print(res.content)
    return {"summary": res.content}



def compare_summaries(state: State) -> dict:
    prompt = f"""
Εντοπίζεις και επεξηγείς δύσκολες ή τεχνικές λέξεις/όρους που συναντώνται στο παρακάτω άρθρο, ώστε να είναι πιο κατανοητό για ένα ευρύ, μη εξειδικευμένο κοινό.

Οδηγίες:
- Αναγνώρισε όρους που μπορεί να είναι δυσνόητοι (π.χ. νομικοί, οικονομικοί, θεσμικοί).
- Για κάθε όρο, γράψε μια σύντομη επεξήγηση (1–2 προτάσεις) σε απλή γλώσσα.
- Απόφυγε την επανάληψη, μην εξηγείς προφανείς λέξεις.
- Απόφυγε αυθαίρετες ερμηνείες ή επιπλέον πληροφορίες που δεν βασίζονται στο άρθρο.

Άρθρο:
{state["article_text"]}
"""
    res = llm.invoke([HumanMessage(content=prompt)])
    return {"explanations": res.content}




#def save_to_file(state: State) -> dict:
    #print("evaluation_count save ", state.get("iteration_count", 0))
#    with open(state["output_path"], "w", encoding="utf-8") as f:
#        f.write(state["summary"])
#    return {"output_path": state["output_path"]}

def save_to_file(state: State) -> dict:
    output_dir = state["output_path"]  # This should now be a directory path (not a file)
    os.makedirs(output_dir, exist_ok=True)  # Ensure the directory exists

    summary_path = os.path.join(output_dir, "summary.txt")
    with open(summary_path, "w", encoding="utf-8") as f:
        f.write(state["summary"])

    if "explanations" in state:
        terms_path = os.path.join(output_dir, "terms.txt")
        with open(terms_path, "w", encoding="utf-8") as f:
            f.write(state["explanations"])
    else:
        terms_path = None

    return {"output_path": state["output_path"]}









